<!DOCTYPE html>
<html>
<head>
  <title>D&D Editor</title>
  <style>
    body { margin: 0; padding-top: 100px; font-family: Arial; }
    .band { 
      height: 200px; 
      border: 2px solid #333; 
      padding: 15px; 
      margin: 10px; 
      overflow-x: auto; 
      background: #f9f9f9; 
      margin-top: 20px;
    }
    .band1 { background: #e1f5fe; }
    .band2 { background: #f3e5f5; }
    .band3 { background: #e8f5e8; }
    .cell { 
      display: inline-block; 
      min-width: 120px; 
      margin: 3px; 
      padding: 8px; 
      border: 1px solid #ccc; 
      background: white; 
    }
    .cell input { 
      width: 100%; 
      border: none; 
      padding: 5px; 
      font-size: 14px; 
      box-sizing: border-box;
    }
    .buttons {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #2196F3;
      padding: 20px;
      z-index: 9999;
      text-align: center;
    }
    button {
      padding: 15px 30px;
      margin: 0 10px;
      background: white;
      color: #2196F3;
      border: 3px solid white;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      font-family: Arial;
    }
    button:hover:not(:disabled) {
      background: #f0f0f0;
    }
    button:disabled {
      background: #ccc;
      color: #666;
      cursor: not-allowed;
    }
    #status {
      position: fixed;
      top: 120px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      background: #4CAF50;
      color: white;
      border-radius: 10px;
      font-weight: bold;
      display: none;
      z-index: 9998;
    }
  </style>
</head>
<body>
  <div class="buttons">
    <button id="loadBtn">ðŸ“¥ CARICA DAL SHEET</button>
    <button id="saveBtn">ðŸ’¾ SALVA SU SHEET</button>
  </div>
  
  <div id="status"></div>
  
  <div id="band1" class="band band1">Riga 1: CLICCA CARICA</div>
  <div id="band2" class="band band2">Riga 2: CLICCA CARICA</div>
  <div id="band3" class="band band3">Banda 3: Futura</div>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzgz_5jCcfefymqwGIUMKaFCKpW6jPxIj-JGc-fUilkBHL8OQVXc73fAu-jHolwM-Dpuw/exec';
    
    function showStatus(msg, isError = false) {
      const status = document.getElementById('status');
      status.textContent = msg;
      status.style.background = isError ? '#f44336' : '#4CAF50';
      status.style.display = 'block';
      setTimeout(() => status.style.display = 'none', 4000);
    }
    
    document.getElementById('loadBtn').addEventListener('click', async function() {
      this.disabled = true;
      this.textContent = 'ðŸ”„ Caricando...';
      showStatus('Caricamento dal Sheet D&D...');
      
      try {
        const response = await fetch(`${WEB_APP_URL}?action=read`);
        const data = await response.json();
        
        if (data.success) {
          renderBand('band1', data.row1 || []);
          renderBand('band2', data.row2 || []);
          showStatus(`âœ… ${data.columns} colonne caricate!`);
        } else {
          throw new Error(data.error || 'Errore server');
        }
      } catch(error) {
        showStatus('âŒ ' + error.message, true);
        console.error('Errore:', error);
      } finally {
        this.disabled = false;
        this.textContent = 'ðŸ“¥ CARICA DAL SHEET';
      }
    });
    
    document.getElementById('saveBtn').addEventListener('click', async function() {
      this.disabled = true;
      this.textContent = 'ðŸ’¾ Salvando...';
      showStatus('Salvataggio su Sheet...');
      
      try {
        const row1Inputs = document.querySelectorAll('#band1 .cell input');
        const row2Inputs = document.querySelectorAll('#band2 .cell input');
        
        const row1 = Array.from(row1Inputs).map(el => el.value || '');
        const row2 = Array.from(row2Inputs).map(el => el.value || '');
        
        const formData = new FormData();
        formData.append('action', 'write');
        formData.append('row1', JSON.stringify(row1));
        formData.append('row2', JSON.stringify(row2));
        
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        if (data.success) {
          showStatus('ðŸŽ‰ SALVATO sul Sheet D&D!');
        } else {
          throw new Error(data.error || 'Errore server');
        }
      } catch(error) {
        showStatus('âŒ ' + error.message, true);
        console.error('Errore save:', error);
      } finally {
        this.disabled = false;
        this.textContent = 'ðŸ’¾ SALVA SU SHEET';
      }
    });
    
    function renderBand(id, data) {
      const band = document.getElementById(id);
      if (!data || data.length === 0) {
        band.innerHTML = 'Nessun dato caricato';
        return;
      }
      band.innerHTML = data.map((cell, i) => 
        `<span class="cell"><input type="text" value="${cell}" data-col="${i}"></span>`
      ).join('');
    }
  </script>
</body>
</html>
